<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  
  <title>设计模式 | chenyulong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
    <meta name="description" content="Nunu&#39;s blog!">
  
  
    <meta name="keywords" content="Nunu">
  
  
    <link rel="alternate" href="/atom.xml" title="chenyulong">
  
  
    <link rel="shortcut icon" href="/css/images/avatar.jpg">
  
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  
    <link rel="stylesheet" href="/localshare/css/share.css">
  
  
  
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">chenyulong</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">理论是你知道是这样，但它却不好用；实践是它很好用，但你不知道是为什么；程序员将理论和实践结合到一起：既不好用，也不知道是为什么。</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/."><i class="fa fa-home"></i> 首页</a>
        
          <a class="main-nav-link" href="/archives"><i class="fa fa-rss"></i> 归档</a>
        
          <a class="main-nav-link" href="/categories/"><i class="fa fa-archive"></i> 分类</a>
        
          <a class="main-nav-link" href="/tags/"><i class="fa fa-user"></i> 标签</a>
        
      </nav>
    </div>
    <div id="search-form">
      <div id="result-mask" class="hide"></div>
      <label><input id="search-key" type="text" autocomplete="off" placeholder="search"></label>
      <div id="result-wrap" class="hide">
        <div id="search-result"></div>
      </div>
      <div class="hide">
        <template id="search-tpl">
          <div class="item">
            <a href="/{path}" title="{title}">
              <div class="title">{title}</div>
              <div class="time">{date}</div>
              <div class="tags">{tags}</div>
            </a>
          </div>
        </template>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-设计模式" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      设计模式
    </h1>
  


      </header>
    
    <div class="article-meta">
      
      <span class="article-date">
  <i class="fa fa-date"></i>
  <time class="dt-published" datetime="2022-06-20T08:44:18.000Z" itemprop="datePublished">2022年06月20日</time>
</span>
      
  <div class="article-category">
    <i class="fa fa-classify"></i>
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

      
        <span class="article-views">
  <i class="fa fa-views"></i>
  <i id="busuanzi_container_page_pv">
      <i id="busuanzi_value_page_pv"></i>
  </i>
</span>

      
      
<a href="/2022/06/20/设计模式/#comments" class="article-comment-link">
  
    
    
    
    
    
  
  <i class="fa fa-commt"></i>
  Guestbook
</a>


    </div>
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="工厂设计模式"><a href="#工厂设计模式" class="headerlink" title="工厂设计模式"></a>工厂设计模式</h2><h3 id="简单工厂模式"><a href="#简单工厂模式" class="headerlink" title="简单工厂模式"></a>简单工厂模式</h3><p><strong>适用场景：</strong></p>
<ul>
<li>工厂类负责创建的对象较少；</li>
<li>客户端只需要传入工厂类的参数，对于如何船舰对象的逻辑不需要关心。</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>只需要传入一个正确的参数，就可以获取你所需要的对象，无须知道其创建的细节。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>不易于扩展过于复杂的产品结构。<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public interface ILanguages &#123;</span><br><span class="line">    void out();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class JavaLanguage implements ILanguages &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void out() &#123;</span><br><span class="line">        System.out.println(&quot;JavaLanguage--------------&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class PythonLanguage implements ILanguages &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void out() &#123;</span><br><span class="line">        System.out.println(&quot;PythonLanguage--------------&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class LanaguageFactory &#123;</span><br><span class="line">    public ILanguages create(Class&lt;?extends ILanguages&gt; clsName)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (null != clsName)&#123;</span><br><span class="line">                return clsName.newInstance();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        System.out.println(&quot;pattern----------------start&quot;);</span><br><span class="line">        ILanguages language = new LanaguageFactory().create(PythonLanguage.class);</span><br><span class="line">        language.out();</span><br><span class="line">        System.out.println(&quot;pattern----------------end&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h3><p>工厂方法模式,Factory Method Pattern，指定义一个创建对象的接口，但让实现这个接口的类来决定实例化哪个类，工厂方法让类的实例化推迟到子类中进行。属于创建型设计模式。<br><strong>适用场景：</strong> </p>
<ul>
<li>创建对象需要大量重复的代码。</li>
<li>客户端(应用层)不依赖产品类实例如何被创建、实现等细节。</li>
<li>一个类通过其子类来指定创建哪个对象。</li>
</ul>
<p><strong>优点：</strong> </p>
<ul>
<li>用户只需关心所需产品对应的工厂，无需关心创建细节。</li>
<li>加入新产品需求符合开闭原则，提高了系统的可扩展性。</li>
</ul>
<p><strong>缺点：</strong> </p>
<ul>
<li>类的个数容易过多，增加了代码的复杂度。</li>
<li>增加了系统的抽象性和理解难度。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">public interface ILanguages &#123;</span><br><span class="line">    void out();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class JavaLanguage implements ILanguages &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void out() &#123;</span><br><span class="line">        System.out.println(&quot;JavaLanguage--------------&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class PythonLanguage implements ILanguages &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void out() &#123;</span><br><span class="line">        System.out.println(&quot;PythonLanguage--------------&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public interface ILanaguageFactory &#123;</span><br><span class="line">     ILanguages create();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class JavaLanguageFactory implements ILanaguageFactory &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public ILanguages create() &#123;</span><br><span class="line">        return new JavaLanguage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class PythonLanguageFactory implements ILanaguageFactory &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public ILanguages create() &#123;</span><br><span class="line">        return new PythonLanguage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        System.out.println(&quot;pattern----------------start&quot;);</span><br><span class="line">        ILanaguageFactory languageFactory = new JavaLanguageFactory();</span><br><span class="line">        ILanguages languages = languageFactory.create();</span><br><span class="line">        languages.out();</span><br><span class="line">        System.out.println(&quot;pattern----------------end&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="抽象工厂模式"><a href="#抽象工厂模式" class="headerlink" title="抽象工厂模式"></a>抽象工厂模式</h3><p>抽象工厂模式(Abastract Factory Pattern)是指提供一个创建一系列相关或相互依赖对象的接口，无须指定他们具体的类。属于创建型设计模式。<br><img src="http://nunu03.github.io/2022/06/20/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/pattern-factory.png" alt><br>产品族：一系列的相关的产品，整合到一起有关联性。<br>产品等级：同一个继承体系。<br><strong>适用场景：</strong> </p>
<ul>
<li>客户端(应用层)不依赖产品类实例如何被创建、实现等细节。</li>
<li>强调一系列相关的产品对象(属于同一产品族)一起使用创建对象需要大量重复的代码。</li>
<li>提供一个产品类的库，所有的产品以同样的接口出现，从而使客户端不依赖于具体实现。</li>
</ul>
<p><strong>优点：</strong> </p>
<ul>
<li>具体产品在应用层代码隔离，无须关心创建细节。</li>
<li>将一个系列的产品族统一到一起创建。</li>
</ul>
<p><strong>缺点：</strong> </p>
<ul>
<li>规定了所有可能被创建的产品集合，产品族中扩展新的产品困难，需要修改抽象工厂的接口。</li>
<li>增加了系统的抽象性和理解难度。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">public interface IFile &#123;</span><br><span class="line">    void setParams();</span><br><span class="line">&#125;</span><br><span class="line">public interface IMethod &#123;</span><br><span class="line">    void setValue();</span><br><span class="line">&#125;</span><br><span class="line">public abstract class LanguageFactory &#123;</span><br><span class="line">    public void init()&#123;</span><br><span class="line">        System.out.println(&quot;初始化&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected  abstract IFile createFile();</span><br><span class="line"></span><br><span class="line">    protected  abstract IMethod createMethod();</span><br><span class="line">&#125;</span><br><span class="line">.......................................................</span><br><span class="line">public class JavaFile implements IFile&#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void setParams() &#123;</span><br><span class="line">        System.out.println(&quot;JavaFile-----setParams&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public class JavaMethod implements  IMethod&#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void setValue() &#123;</span><br><span class="line">        System.out.println(&quot;JavaMethod-----setValue&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public class JavaLanguageFactory extends LanguageFactory &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected IFile createFile() &#123;</span><br><span class="line">        super.init();</span><br><span class="line">        return new JavaFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected IMethod createMethod() &#123;</span><br><span class="line">        super.init();</span><br><span class="line">        return new JavaMethod();</span><br><span class="line">&#125;</span><br><span class="line">.......................................................</span><br><span class="line">public class PythonFile implements IFile &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void setParams() &#123;</span><br><span class="line">        System.out.println(&quot;PythonFile-----setParams&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public class PythonMethod implements IMethod &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void setValue() &#123;</span><br><span class="line">        System.out.println(&quot;PythonMethod-----setValue&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public class PythonLanguageFactory extends LanguageFactory &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected IFile createFile() &#123;</span><br><span class="line">        super.init();</span><br><span class="line">        return new PythonFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected IMethod createMethod() &#123;</span><br><span class="line">        super.init();</span><br><span class="line">        return new PythonMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">.......................................................</span><br><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        System.out.println(&quot;pattern----------------start&quot;);</span><br><span class="line">        LanguageFactory factory = new JavaLanguageFactory();</span><br><span class="line">        factory.createFile().setParams();</span><br><span class="line">        factory.createMethod().setValue();</span><br><span class="line">        System.out.println(&quot;pattern----------------end&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>比如在58同城IM source体系中，具体的业务实现，可以分为交友与同镇，同城等，三者大部分业务相同，但是也有不同的业务卡片。</p>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>单例模式(Singleton Pattern) 是指确保一个类在任何情况下都绝对只有一个实例，并提供一个全局访问点，防止重复创建。隐藏其所有的构造方法。属于创建型模式。<br><strong>适用场景：</strong></p>
<ul>
<li>确保任何情况下都绝对只有一个实例。ApplicationContext、ServletConfig、DBPool。</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>在内存中只有一个实例，减少了内存开销。</li>
<li>可以避免对资源的多重占用。</li>
<li>设置全局访问点，严格控制访问。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>没有接口，扩展困难。</li>
<li>如果要扩展单例对象，只有修改代码，没有其他途径。<h3 id="饿汉式单例"><a href="#饿汉式单例" class="headerlink" title="饿汉式单例"></a>饿汉式单例</h3>在单例类首次加载时就创建实例。</li>
<li><em>优点：*</em></li>
<li>执行效率高</li>
<li>性能高</li>
<li>没有任何锁</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>某些情况下，可能会造成内存浪费(类加载就会创建，但不一定会被使用)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class HungrySingleton &#123;</span><br><span class="line">    private static HungrySingleton mInstanace = new HungrySingleton();</span><br><span class="line">    private HungrySingleton()&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public static HungrySingleton getInstance()&#123;</span><br><span class="line">        return mInstanace;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>另一种写法：和上述没本质区别；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class HungryStaticSingleton &#123;</span><br><span class="line">    // 类加载顺序：先静态后动态；先上，后下；先属性后方法。</span><br><span class="line">    private static final HungryStaticSingleton mInstance;</span><br><span class="line">    //在静态代码块中初始化：</span><br><span class="line">    static &#123;</span><br><span class="line">       mInstance = new HungryStaticSingleton();</span><br><span class="line">    &#125;</span><br><span class="line">    private HungryStaticSingleton()&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public static HungryStaticSingleton getInstance()&#123;</span><br><span class="line">        return mInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="懒汉式单例"><a href="#懒汉式单例" class="headerlink" title="懒汉式单例"></a>懒汉式单例</h3><p>被外部类调用时才创建实例。<br><strong>优点：</strong></p>
<ul>
<li>在调用时创建实例，节省内存。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>多线程时，如果同时都进入条件，会导致多线程不安全，指令重排序问题。</li>
</ul>
<h4 id="线程不安全"><a href="#线程不安全" class="headerlink" title="线程不安全"></a>线程不安全</h4><p>如果两个线程同时调用，有可能创建两个不同实例。</p>
<ul>
<li>同一个实例：</li>
</ul>
<p>1.正常顺序执行，正常结果<br>2.同时进入条件，后一个覆盖前一个实例，异常情况。</p>
<ul>
<li>不同实例：<br>同时进入条件，按顺序返回</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class LazySington &#123;</span><br><span class="line">    private static LazySington mInstance;</span><br><span class="line">    private LazySington()&#123;&#125;</span><br><span class="line">    public static LazySington getInstance()&#123;</span><br><span class="line">        if (null == mInstance)&#123;</span><br><span class="line">            mInstance = new LazySington();</span><br><span class="line">        &#125;</span><br><span class="line">        return mInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h4><p>增加synchronized锁：当有线程执行到条件RUNNING时，其他的线程状态是MONITOR状态，不能进入getInstance()，而是进入监听等待状态，即为阻塞。当第一线程执行完后，其他的线程状态改为了RUNNING，继续执行。<br>但是这个synchronized阻塞了所有资源，即使mInstance不为空，也会阻塞。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class LazySington &#123;</span><br><span class="line">    private static LazySington mInstance;</span><br><span class="line">    private LazySington()&#123;&#125;</span><br><span class="line">    public synchronized static LazySington getInstance()&#123;</span><br><span class="line">        if (null == mInstance)&#123;</span><br><span class="line">            mInstance = new LazySington();</span><br><span class="line">        &#125;</span><br><span class="line">        return mInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改进,使阻塞粒度变得更小：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class LazySington &#123;</span><br><span class="line">    private static LazySington mInstance;</span><br><span class="line">    private LazySington()&#123;&#125;</span><br><span class="line">    public static LazySington getInstance()&#123;</span><br><span class="line">        if (null == mInstance)&#123;</span><br><span class="line">            synchronized (LazySington.class)&#123;</span><br><span class="line">                mInstance = new LazySington();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return mInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次改进：看双重校验</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="双重校验"><a href="#双重校验" class="headerlink" title="双重校验"></a>双重校验</h4><p>但是这个时候如果多线程问题，还时存在指令重排问题的：解决方案，就是增加 volatile<br><strong>优点：</strong></p>
<ul>
<li>性能高，线程安全</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>可读性差，多重判空</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class LazySington &#123;</span><br><span class="line">    private volatile static LazySington mInstance;</span><br><span class="line">    private LazySington()&#123;&#125;</span><br><span class="line">    public static LazySington getInstance()&#123;</span><br><span class="line">        // 检查是否阻塞</span><br><span class="line">        if (null == mInstance)&#123;</span><br><span class="line">            synchronized (LazySington.class)&#123;</span><br><span class="line">                // 检查是否重新创建实例</span><br><span class="line">                if (null == mInstance)&#123;</span><br><span class="line">                    mInstance = new LazySington();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return mInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a>静态内部类</h4><p><strong>优点：</strong></p>
<ul>
<li>写法优雅，利用了java本身的语法特点</li>
<li>性能高，避免了内存浪费</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>能够被反射破坏，其实上述单例都能够被破坏。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 先加载类：首先加载LazyInnerSingleton.class</span><br><span class="line"> * 再加载内部类：LazyInnerSingleton&amp;LazyInnerSingletonHolder.class</span><br><span class="line"> */</span><br><span class="line">public class LazyInnerSingleton &#123;</span><br><span class="line">    private LazyInnerSingleton()&#123;&#125;</span><br><span class="line">    public static LazyInnerSingleton getInstance()&#123;</span><br><span class="line">        return LazyInnerSingletonHolder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">    //只在使用的时候才分配内存，进行加载</span><br><span class="line">    private static class LazyInnerSingletonHolder&#123;</span><br><span class="line">        private static final LazyInnerSingleton INSTANCE = new LazyInnerSingleton();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="反射破坏单例"><a href="#反射破坏单例" class="headerlink" title="反射破坏单例"></a>反射破坏单例</h3><p>以静态内部类反射为例：<br><strong>反射：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class ReflectTest &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        try&#123;</span><br><span class="line">            Class&lt;?&gt; clazz = LazyInnerSingleton.class;</span><br><span class="line">            Constructor constructor = clazz.getDeclaredConstructor();</span><br><span class="line">            constructor.setAccessible(true);</span><br><span class="line">            Object instance = constructor.newInstance();</span><br><span class="line">            System.out.println(instance);</span><br><span class="line">            Object instance1 = constructor.newInstance();</span><br><span class="line">            System.out.println(instance1);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.javadesignpatterns.Singleton.lazy.LazyInnerSingleton@15db9742</span><br><span class="line">com.javadesignpatterns.Singleton.lazy.LazyInnerSingleton@6d06d69c</span><br></pre></td></tr></table></figure>

<p>所以，多个实例，违背了单例的单一原则。<br>所以改进,在构造方法中增加非空判断：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 先加载类：首先加载LazyInnerSingleton.class</span><br><span class="line"> * 再加载内部类：LazyInnerSingleton&amp;LazyInnerSingletonHolder.class</span><br><span class="line"> */</span><br><span class="line">public class LazyInnerSingleton &#123;</span><br><span class="line">    private LazyInnerSingleton()&#123;</span><br><span class="line">        if (LazyInnerSingletonHolder.INSTANCE != null)&#123;</span><br><span class="line">            throw new RuntimeException(&quot;不允许非法的访问&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public static LazyInnerSingleton getInstance()&#123;</span><br><span class="line">        return LazyInnerSingletonHolder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">    //只在使用的时候才分配内存，进行加载</span><br><span class="line">    private static class LazyInnerSingletonHolder&#123;</span><br><span class="line">        private static final LazyInnerSingleton INSTANCE = new LazyInnerSingleton();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>输出：Caused by: java.lang.RuntimeException: 不允许非法的访问</strong></p>
<p><strong>优点：</strong></p>
<ul>
<li>写法优雅，利用了java本身的语法特点</li>
<li>性能高，避免了内存浪费</li>
<li>不能被反射破坏</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>代码不优雅。<br>那如何再次改进，看注册式单例：<h3 id="注册式单例"><a href="#注册式单例" class="headerlink" title="注册式单例"></a>注册式单例</h3>大批量创建单例，将每一个实例都缓存到统一的容器中，使用唯一标识获取实例。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class ContainerSingleton &#123;</span><br><span class="line">    private ContainerSingleton()&#123;&#125;</span><br><span class="line">    private static Map&lt;String,Object&gt; ioc = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    public static Object getInstance(String className)&#123;</span><br><span class="line">        if (!ioc.containsKey(className))&#123;</span><br><span class="line">            Object instance = null;</span><br><span class="line">            try &#123;</span><br><span class="line">                instance = Class.forName(className).newInstance();</span><br><span class="line">                ioc.put(className,instance);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            return instance;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            return ioc.get(className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="序列化、反序列化破坏单例"><a href="#序列化、反序列化破坏单例" class="headerlink" title="序列化、反序列化破坏单例"></a>序列化、反序列化破坏单例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class SeriableHungrySingleton implements Serializable &#123;</span><br><span class="line">    //序列化：把内存中对象的状态转换为字节码的形式，再把字节码通过IO输出流，写到磁盘上，永久保存，持久化。</span><br><span class="line"></span><br><span class="line">    //反序列化：将持久化的字节码内容通过IO输入流读到内存中来，再转换成一个对象。</span><br><span class="line"></span><br><span class="line">    private static SeriableHungrySingleton mInstanace = new SeriableHungrySingleton();</span><br><span class="line">    private SeriableHungrySingleton()&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public static SeriableHungrySingleton getInstance()&#123;</span><br><span class="line">        return mInstanace;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class SeriableHungrySingletonTest &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        SeriableHungrySingleton s1 = null;</span><br><span class="line">        SeriableHungrySingleton s2 = SeriableHungrySingleton.getInstance();</span><br><span class="line">        FileOutputStream fos = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            fos = new FileOutputStream(&quot;SeriableHungrySingleton.obj&quot;);</span><br><span class="line">            ObjectOutputStream oos = new ObjectOutputStream(fos);</span><br><span class="line">            oos.writeObject(s2);</span><br><span class="line">            oos.flush();;</span><br><span class="line">            oos.close();</span><br><span class="line"></span><br><span class="line">            FileInputStream fis = new FileInputStream(&quot;SeriableHungrySingleton.obj&quot;);</span><br><span class="line">            ObjectInputStream ois = new ObjectInputStream(fis);</span><br><span class="line">            s1 = (SeriableHungrySingleton)ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line"></span><br><span class="line">            System.out.println(s1);</span><br><span class="line">            System.out.println(s2);</span><br><span class="line">            System.out.println(s1==s2);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：两次得到的实例不一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.javadesignpatterns.seriable.SeriableHungrySingleton@776ec8df</span><br><span class="line">com.javadesignpatterns.seriable.SeriableHungrySingleton@5c647e05</span><br><span class="line">false</span><br></pre></td></tr></table></figure>

<p>如何解决：增加一个readResolve()方法</p>
<figure class="highlight plain"><figcaption><span>class SeriableHungrySingleton implements Serializable &#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    .............</span><br><span class="line">    private Object readResolve()&#123;</span><br><span class="line">        return mInstanace;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试，输入结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.javadesignpatterns.seriable.SeriableHungrySingleton@5c647e05</span><br><span class="line">com.javadesignpatterns.seriable.SeriableHungrySingleton@5c647e05</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>那为什么加一个readResolve，就解决了呢？需要看readObject源码，在这个源码里有一个<br> checkResolve(readOrdinaryObject(unshared));</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">private Object readOrdinaryObject(boolean unshared)</span><br><span class="line">    。。。。。。。。。。。。。。。。。。。。。</span><br><span class="line">    Object obj;</span><br><span class="line">        try &#123;</span><br><span class="line">            // newInstance，创建实例</span><br><span class="line">            obj = desc.isInstantiable() ? desc.newInstance() : null;</span><br><span class="line">        &#125; catch (Exception ex) &#123;</span><br><span class="line">            throw (IOException) new InvalidClassException(</span><br><span class="line">                desc.forClass().getName(),</span><br><span class="line">                &quot;unable to create instance&quot;).initCause(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        passHandle = handles.assign(unshared ? unsharedMarker : obj);</span><br><span class="line">        ClassNotFoundException resolveEx = desc.getResolveException();</span><br><span class="line">        if (resolveEx != null) &#123;</span><br><span class="line">            handles.markException(passHandle, resolveEx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (desc.isExternalizable()) &#123;</span><br><span class="line">            readExternalData((Externalizable) obj, desc);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            readSerialData(obj, desc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        handles.finish(passHandle);</span><br><span class="line">    if (obj != null &amp;&amp;</span><br><span class="line">        handles.lookupException(passHandle) == null &amp;&amp;</span><br><span class="line">        desc.hasReadResolveMethod())</span><br><span class="line">    &#123;</span><br><span class="line">        //通过反射获取ReadResolve对象，这个就是我们单例中readResolve返回的对象</span><br><span class="line">        Object rep = desc.invokeReadResolve(obj);</span><br><span class="line">        if (unshared &amp;&amp; rep.getClass().isArray()) &#123;</span><br><span class="line">            rep = cloneArray(rep);</span><br><span class="line">        &#125;</span><br><span class="line">        //如果跟newInstance的对象不一样，就赋值给obj，返回，这个就不时新创建新的对象了。</span><br><span class="line">        if (rep != obj) &#123;</span><br><span class="line">            // Filter the replacement object</span><br><span class="line">            if (rep != null) &#123;</span><br><span class="line">                if (rep.getClass().isArray()) &#123;</span><br><span class="line">                    filterCheck(rep.getClass(), Array.getLength(rep));</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    filterCheck(rep.getClass(), -1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            handles.setObject(passHandle, obj = rep);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private Object checkResolve(Object obj) throws IOException &#123;</span><br><span class="line">    if (!enableResolve || handles.lookupException(passHandle) != null) &#123;</span><br><span class="line">        return obj;</span><br><span class="line">    &#125;</span><br><span class="line">    Object rep = resolveObject(obj);</span><br><span class="line">    if (rep != obj) &#123;</span><br><span class="line">        // The type of the original object has been filtered but resolveObject</span><br><span class="line">        // may have replaced it;  filter the replacement&apos;s type</span><br><span class="line">        if (rep != null) &#123;</span><br><span class="line">            if (rep.getClass().isArray()) &#123;</span><br><span class="line">                filterCheck(rep.getClass(), Array.getLength(rep));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                filterCheck(rep.getClass(), -1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handles.setObject(passHandle, rep);</span><br><span class="line">    &#125;</span><br><span class="line">    return rep;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ThreadLocal单例"><a href="#ThreadLocal单例" class="headerlink" title="ThreadLocal单例"></a>ThreadLocal单例</h3><p>保证线程内部的全局唯一，且天生线程安全。但是在不同的线程，肯定是不同的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class ThreadLocalSingleton &#123;</span><br><span class="line">    public static ThreadLocalSingleton getInstance()&#123;</span><br><span class="line">        return threadLocalInstance.get();</span><br><span class="line">    &#125;</span><br><span class="line">    private ThreadLocalSingleton()&#123;&#125;</span><br><span class="line">    private static final ThreadLocal&lt;ThreadLocalSingleton&gt; threadLocalInstance =</span><br><span class="line">            new ThreadLocal&lt;ThreadLocalSingleton&gt;()&#123;</span><br><span class="line">                @Override</span><br><span class="line">                protected ThreadLocalSingleton initialValue() &#123;</span><br><span class="line">                    return new ThreadLocalSingleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class ThreadLocalSingletonTest &#123;</span><br><span class="line">    //在主线程</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        System.out.println(ThreadLocalSingleton.getInstance());</span><br><span class="line">        System.out.println(ThreadLocalSingleton.getInstance());</span><br><span class="line">        System.out.println(ThreadLocalSingleton.getInstance());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.javadesignpatterns.Singleton.threadlocal.ThreadLocalSingleton@15db9742</span><br><span class="line">com.javadesignpatterns.Singleton.threadlocal.ThreadLocalSingleton@15db9742</span><br><span class="line">com.javadesignpatterns.Singleton.threadlocal.ThreadLocalSingleton@15db9742</span><br></pre></td></tr></table></figure>

<p>ThreadLocal：getEntry(this),就是当前线程位key。从map中获取：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public T get() &#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    if (map != null) &#123;</span><br><span class="line">        ThreadLocalMap.Entry e = map.getEntry(this);</span><br><span class="line">        if (e != null) &#123;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            T result = (T)e.value;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return setInitialValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>1.私有化构造方法。</li>
<li>2.保证线程安全。</li>
<li>3.延迟加载。</li>
<li>4.防止序列化和反序列化破坏单例。</li>
<li>5.防止反射攻击单例。<h2 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h2>原型模式(Prototype Pattern),是指原型实例指定创建对象的种类，并且通过拷贝这些原型创建新的对象。调用者不需要知道任何创建细节，不调用构造函数。属于创建型模式。</li>
<li><em>适用场景：*</em></li>
<li>类初始化消耗资源较多。</li>
<li>new 产生的一个对象需要非常繁琐的过程（数据准备、访问权限等）。</li>
<li>构造函数比较复杂。</li>
<li>循环体中生成大量对象时。</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>在内存中只有一个实例，减少了内存开销。</li>
<li>可以避免对资源的多重占用。</li>
<li>设置全局访问点，严格控制访问。</li>
</ul>
<p>通用写法举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public interface IPrototype&lt;T&gt; &#123;</span><br><span class="line">    T clone();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class LanguageBean implements IPrototype&#123;</span><br><span class="line">    public String id;</span><br><span class="line">    public String name;</span><br><span class="line">    public String nickName;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public LanguageBean clone() &#123;</span><br><span class="line">        LanguageBean languageBean = new LanguageBean();</span><br><span class="line">        languageBean.id = &quot;2&quot;;</span><br><span class="line">        languageBean.name =&quot;java&quot;;</span><br><span class="line">        languageBean.nickName=&quot;javaName&quot;;</span><br><span class="line">        return languageBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;LanguageBean&#123;&quot; +</span><br><span class="line">                &quot;id=&apos;&quot; + id + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, name=&apos;&quot; + name + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, nickName=&apos;&quot; + nickName + &apos;\&apos;&apos; +</span><br><span class="line">                &apos;&#125;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//也可以通过反射赋值clone，在58时曾经用过这种方式。</span><br><span class="line">public class LanguageUtils &#123;</span><br><span class="line">    public static Object copy(Object prototype)&#123;</span><br><span class="line">        Class clazz = prototype.getClass();</span><br><span class="line">        Object objectVlue = null;</span><br><span class="line">        try&#123;</span><br><span class="line">            objectVlue = clazz.newInstance();</span><br><span class="line">            for (Field field: clazz.getDeclaredFields())&#123;</span><br><span class="line">                field.setAccessible(true);</span><br><span class="line">                field.set(objectVlue,field.get(prototype));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return  objectVlue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        System.out.println(&quot;pattern----------------start&quot;);</span><br><span class="line">        //创建原型对象</span><br><span class="line">        LanguageBean languageBean = new LanguageBean();</span><br><span class="line">        languageBean.id = &quot;2&quot;;</span><br><span class="line">        languageBean.name =&quot;java&quot;;</span><br><span class="line">        languageBean.nickName=&quot;javaName&quot;;</span><br><span class="line">        System.out.println(languageBean);</span><br><span class="line">        // 拷贝原型对象</span><br><span class="line">        LanguageBean cloneBean = languageBean.clone();</span><br><span class="line">        System.out.println(cloneBean);</span><br><span class="line">        System.out.println(&quot;pattern----------------end&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：一模一样，荣国方法clone，没有通过new。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pattern----------------start</span><br><span class="line">LanguageBean&#123;id=&apos;2&apos;, name=&apos;java&apos;, nickName=&apos;javaName&apos;&#125;</span><br><span class="line">LanguageBean&#123;id=&apos;2&apos;, name=&apos;java&apos;, nickName=&apos;javaName&apos;&#125;</span><br><span class="line">pattern----------------end</span><br></pre></td></tr></table></figure>

<h3 id="浅克隆"><a href="#浅克隆" class="headerlink" title="浅克隆"></a>浅克隆</h3><p>使用jdk的Cloneable接口，它的实现是在Object类中,而Object的clone是一个native方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @author  unascribed</span><br><span class="line"> * @see     java.lang.CloneNotSupportedException</span><br><span class="line"> * @see     java.lang.Object#clone()</span><br><span class="line"> * @since   JDK1.0</span><br><span class="line"> */</span><br><span class="line">public interface Cloneable &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Object &#123;</span><br><span class="line">    protected native Object clone() throws CloneNotSupportedException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class LanguageBean implements Cloneable &#123;</span><br><span class="line">    public String id;</span><br><span class="line">    public String name;</span><br><span class="line">    public String nickName;</span><br><span class="line">    public List&lt;String&gt; method;//添加一个list</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public LanguageBean clone() &#123;</span><br><span class="line">        try&#123;</span><br><span class="line">            return (LanguageBean)super.clone();</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;LanguageBean&#123;&quot; +</span><br><span class="line">                &quot;id=&apos;&quot; + id + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, name=&apos;&quot; + name + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, nickName=&apos;&quot; + nickName + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, method=&quot; + method +</span><br><span class="line">                &apos;&#125;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args)&#123;</span><br><span class="line">    System.out.println(&quot;pattern----------------start&quot;);</span><br><span class="line">    //创建原型对象</span><br><span class="line">    LanguageBean languageBean = new LanguageBean();</span><br><span class="line">    languageBean.id = &quot;2&quot;;</span><br><span class="line">    languageBean.name =&quot;java&quot;;</span><br><span class="line">    languageBean.nickName=&quot;javaName&quot;;</span><br><span class="line">    List&lt;String&gt; listMethod = new ArrayList&lt;String&gt;();</span><br><span class="line">    listMethod.add(&quot;money&quot;);</span><br><span class="line">    listMethod.add(&quot;cat&quot;);</span><br><span class="line">    languageBean.method = listMethod;</span><br><span class="line">    System.out.println(languageBean);</span><br><span class="line">    // 拷贝原型对象</span><br><span class="line">    LanguageBean cloneBean = languageBean.clone();</span><br><span class="line">    cloneBean.method.add(&quot;dog&quot;);</span><br><span class="line">    System.out.println(cloneBean);</span><br><span class="line">    System.out.println(languageBean);</span><br><span class="line">    System.out.println(languageBean==cloneBean);</span><br><span class="line">    System.out.println(&quot;pattern----------------end&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pattern----------------start</span><br><span class="line">LanguageBean&#123;id=&apos;2&apos;, name=&apos;java&apos;, nickName=&apos;javaName&apos;, method=[money, cat]&#125;</span><br><span class="line">LanguageBean&#123;id=&apos;2&apos;, name=&apos;java&apos;, nickName=&apos;javaName&apos;, method=[money, cat, dog]&#125;</span><br><span class="line">LanguageBean&#123;id=&apos;2&apos;, name=&apos;java&apos;, nickName=&apos;javaName&apos;, method=[money, cat, dog]&#125;</span><br><span class="line">false</span><br><span class="line">pattern----------------end</span><br></pre></td></tr></table></figure>

<p>可以看到，第2和3打印的结果竟然一致，但是我们第三个原型对象并没有添加dog。并且原型和克隆对象的地址不是一个（打印的结果时false）。<br>再打印下List对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(cloneBean.method);</span><br><span class="line">System.out.println(languageBean.method);</span><br><span class="line">System.out.println(languageBean.method==cloneBean.method);</span><br></pre></td></tr></table></figure>

<p>输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[money, cat, dog]</span><br><span class="line">[money, cat, dog]</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>所以，两个对象中的List地址是一样的，也就是共用了一个List对象。所以，通过Cloneable的clone的对象，如果是引用类型属性，只是拷贝了内存地址，并没有拷贝具体的元素。所以当改变元素内容时，也改变了原型对象内的元素。<br><strong>解决方案：深克隆</strong></p>
<h3 id="深克隆"><a href="#深克隆" class="headerlink" title="深克隆"></a>深克隆</h3><p>不使用默认的clone，而是通过序列化和反序列化进行克隆，或者通过转换成JSON:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public class LanguageBean implements Cloneable , Serializable &#123;</span><br><span class="line">    public String id;</span><br><span class="line">    public String name;</span><br><span class="line">    public String nickName;</span><br><span class="line">    public List&lt;String&gt; method;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public LanguageBean clone() &#123;</span><br><span class="line">        try&#123;</span><br><span class="line">            return (LanguageBean)super.clone();</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //通过序列化克隆</span><br><span class="line">    public LanguageBean deepClone()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ByteArrayOutputStream bos = new ByteArrayOutputStream();</span><br><span class="line">            ObjectOutputStream oos = new ObjectOutputStream(bos);</span><br><span class="line">            oos.writeObject(this);</span><br><span class="line"></span><br><span class="line">            ByteArrayInputStream bis = new ByteArrayInputStream(bos.toByteArray());</span><br><span class="line">            ObjectInputStream ois = new ObjectInputStream(bis);</span><br><span class="line">            return (LanguageBean)ois.readObject();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;LanguageBean&#123;&quot; +</span><br><span class="line">                &quot;id=&apos;&quot; + id + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, name=&apos;&quot; + name + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, nickName=&apos;&quot; + nickName + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, method=&quot; + method +</span><br><span class="line">                &apos;&#125;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试一下啊：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args)&#123;</span><br><span class="line">    System.out.println(&quot;pattern----------------start&quot;);</span><br><span class="line">    //创建原型对象</span><br><span class="line">    LanguageBean languageBean = new LanguageBean();</span><br><span class="line">    languageBean.id = &quot;2&quot;;</span><br><span class="line">    languageBean.name =&quot;java&quot;;</span><br><span class="line">    languageBean.nickName=&quot;javaName&quot;;</span><br><span class="line">    List&lt;String&gt; listMethod = new ArrayList&lt;String&gt;();</span><br><span class="line">    listMethod.add(&quot;money&quot;);</span><br><span class="line">    listMethod.add(&quot;cat&quot;);</span><br><span class="line">    languageBean.method = listMethod;</span><br><span class="line">    System.out.println(languageBean);</span><br><span class="line">    // 拷贝原型对象</span><br><span class="line">    LanguageBean cloneBean = languageBean.deepClone();</span><br><span class="line">    cloneBean.method.add(&quot;dog&quot;);</span><br><span class="line">    System.out.println(cloneBean);</span><br><span class="line">    System.out.println(languageBean);</span><br><span class="line">    System.out.println(languageBean==cloneBean);</span><br><span class="line"></span><br><span class="line">    System.out.println(cloneBean.method);</span><br><span class="line">    System.out.println(languageBean.method);</span><br><span class="line">    System.out.println(languageBean.method==cloneBean.method);</span><br><span class="line">    System.out.println(&quot;pattern----------------end&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：没问题了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pattern----------------start</span><br><span class="line">LanguageBean&#123;id=&apos;2&apos;, name=&apos;java&apos;, nickName=&apos;javaName&apos;, method=[money, cat]&#125;</span><br><span class="line">LanguageBean&#123;id=&apos;2&apos;, name=&apos;java&apos;, nickName=&apos;javaName&apos;, method=[money, cat, dog]&#125;</span><br><span class="line">LanguageBean&#123;id=&apos;2&apos;, name=&apos;java&apos;, nickName=&apos;javaName&apos;, method=[money, cat]&#125;</span><br><span class="line">false</span><br><span class="line">[money, cat, dog]</span><br><span class="line">[money, cat]</span><br><span class="line">false</span><br><span class="line">pattern----------------end</span><br></pre></td></tr></table></figure>

<p><strong>但是这个deepClone，也有可能是有问题的，如果这个原型是个单例，就有可能被破坏。所以如果是单例，就不能实现Cloneable的clone接口，或者实现的话，就直接返回instance。所以原型和单例其实是互斥的。</strong></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.bilibili.com/video/BV1L5411R7BP?p=4&spm_id_from=pageDriver&vd_source=5442b4c25ece27e33e3aeca4f29ec7f6" target="_blank" rel="noopener">从未见过如此通俗易懂的Java设计模式教程</a></p>

        
            <div id="toc-article">
                
  <div class="widget-wrap" id="toc-wrap">
    <h3 class="widget-title"><i class="fa fa-toc"></i> Contents</h3>
    <div class="widget">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#工厂设计模式"><span class="toc-text">工厂设计模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简单工厂模式"><span class="toc-text">简单工厂模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#工厂方法模式"><span class="toc-text">工厂方法模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#抽象工厂模式"><span class="toc-text">抽象工厂模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#单例模式"><span class="toc-text">单例模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#饿汉式单例"><span class="toc-text">饿汉式单例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#懒汉式单例"><span class="toc-text">懒汉式单例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#线程不安全"><span class="toc-text">线程不安全</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线程安全"><span class="toc-text">线程安全</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#双重校验"><span class="toc-text">双重校验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#静态内部类"><span class="toc-text">静态内部类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#反射破坏单例"><span class="toc-text">反射破坏单例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注册式单例"><span class="toc-text">注册式单例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#序列化、反序列化破坏单例"><span class="toc-text">序列化、反序列化破坏单例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal单例"><span class="toc-text">ThreadLocal单例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#原型模式"><span class="toc-text">原型模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#浅克隆"><span class="toc-text">浅克隆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#深克隆"><span class="toc-text">深克隆</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-text">参考资料</span></a></li></ol>
    </div>
  </div>


            </div>
        
        
          <blockquote id="copyright">
              <p>Original link: <a href="http://nunu03.github.io/2022/06/20/设计模式/">http://nunu03.github.io/2022/06/20/设计模式/</a></p>
              <p>Copyright Notice: 转载请注明出处.</p>
          </blockquote>
        
      
    </div>
    <footer class="article-footer">
      
        <div class="article-tag-wrap">
          

          
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>

          
    <div class="social-share">
      <span>Share:</span>
    </div>



        </div>
      
      
        
<nav id="article-nav">
  
    <a href="/2022/06/09/手写实现ARouter/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">older</strong>
      <div class="article-nav-title">
        
          手写实现ARouter
        
      </div>
    </a>
  
  
</nav>

      
      
        








      
    </footer>
  </div>
</article>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-posts"></i> Recent</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/06/20/设计模式/">设计模式</a>
          </li>
        
          <li>
            <a href="/2022/06/09/手写实现ARouter/">手写实现ARouter</a>
          </li>
        
          <li>
            <a href="/2022/06/08/Glide图片加载框架原理/">Glide图片加载框架原理</a>
          </li>
        
          <li>
            <a href="/2022/06/07/SPI原理解析/">SPI原理解析</a>
          </li>
        
          <li>
            <a href="/2022/06/03/SharedPreferences-MMAP-MMKV数据持久化原理解析/">SharedPreferences+MMAP+MMKV数据持久化原理解析</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-tag"></i> Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/CMake/" style="font-size: 10px;">CMake</a> <a href="/tags/Charles/" style="font-size: 13.33px;">Charles</a> <a href="/tags/Color/" style="font-size: 10px;">Color</a> <a href="/tags/FaceUnity/" style="font-size: 16.67px;">FaceUnity</a> <a href="/tags/Fix/" style="font-size: 10px;">Fix</a> <a href="/tags/Flutter/" style="font-size: 10px;">Flutter</a> <a href="/tags/GitLab/" style="font-size: 10px;">GitLab</a> <a href="/tags/Glide/" style="font-size: 10px;">Glide</a> <a href="/tags/Gradle/" style="font-size: 20px;">Gradle</a> <a href="/tags/Haar/" style="font-size: 10px;">Haar</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Hook/" style="font-size: 10px;">Hook</a> <a href="/tags/Kotlin/" style="font-size: 10px;">Kotlin</a> <a href="/tags/LiveData/" style="font-size: 10px;">LiveData</a> <a href="/tags/Log/" style="font-size: 10px;">Log</a> <a href="/tags/OkHttp/" style="font-size: 10px;">OkHttp</a> <a href="/tags/OpenCV/" style="font-size: 10px;">OpenCV</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Retrofit/" style="font-size: 10px;">Retrofit</a> <a href="/tags/SPI/" style="font-size: 10px;">SPI</a> <a href="/tags/Title/" style="font-size: 10px;">Title</a> <a href="/tags/Toast/" style="font-size: 10px;">Toast</a> <a href="/tags/View/" style="font-size: 10px;">View</a> <a href="/tags/ViewModel/" style="font-size: 10px;">ViewModel</a> <a href="/tags/WMS/" style="font-size: 10px;">WMS</a> <a href="/tags/WebHook/" style="font-size: 10px;">WebHook</a> <a href="/tags/Wireshark/" style="font-size: 10px;">Wireshark</a> <a href="/tags/Xposed/" style="font-size: 13.33px;">Xposed</a> <a href="/tags/aar/" style="font-size: 10px;">aar</a> <a href="/tags/cmd/" style="font-size: 10px;">cmd</a> <a href="/tags/mmap/" style="font-size: 10px;">mmap</a> <a href="/tags/ngrok/" style="font-size: 13.33px;">ngrok</a> <a href="/tags/nps/" style="font-size: 10px;">nps</a> <a href="/tags/人脸检测/" style="font-size: 10px;">人脸检测</a> <a href="/tags/组件化/" style="font-size: 10px;">组件化</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-classify"></i> Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Charles/">Charles</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flutter/">Flutter</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GitLab/">GitLab</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/">Gradle</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Log/">Log</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Log/Fix/">Fix</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/NDK/">NDK</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenCV/">OpenCV</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Video/">Video</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebHook/">WebHook</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/WebHook/ngrok/">ngrok</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/cmd/">cmd</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ngrok/">ngrok</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/ngrok/nps/">nps</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/人脸检测/">人脸检测</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/人脸检测/Haar/">Haar</a><span class="category-list-count">1</span></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-archive"></i> Archive</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022年</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021年</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020年</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019年</a><span class="archive-list-count">16</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-tag"></i> Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CMake/">CMake</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Charles/">Charles</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Color/">Color</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FaceUnity/">FaceUnity</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fix/">Fix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flutter/">Flutter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitLab/">GitLab</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Glide/">Glide</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/">Gradle</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Haar/">Haar</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hook/">Hook</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kotlin/">Kotlin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LiveData/">LiveData</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Log/">Log</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OkHttp/">OkHttp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenCV/">OpenCV</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Retrofit/">Retrofit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SPI/">SPI</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Title/">Title</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Toast/">Toast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/View/">View</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ViewModel/">ViewModel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WMS/">WMS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebHook/">WebHook</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Wireshark/">Wireshark</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xposed/">Xposed</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aar/">aar</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cmd/">cmd</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mmap/">mmap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ngrok/">ngrok</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nps/">nps</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/人脸检测/">人脸检测</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/组件化/">组件化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-link"></i> Blogroll</h3>
    <div class="widget">
      <ul>
      
        <li>
          <a href="https://handsomeliuyang.github.io/">liuyang</a>
        </li>
      
      </ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <a id="totop" href="#top"></a>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <p>
        <a href="/sitemap.xml">Site Map</a>
        <span> | </span><a href="/atom.xml">Subscribe to this site</a>
        <span> | </span><a href="/about/">Contact the blogger</a>
      </p>
      
        <p>
          <i class="fa fa-visitors"></i>
          <i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>
          ，
          <i class="fa fa-views"></i>
          <i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>
        </p>
      
      <p>
        <span>Copyright &copy; 2022 Nunu Long.</span>
        <span>Theme by <a href="https://github.com/chaooo/hexo-theme-BlueLake/" target="_blank">BlueLake.</a></span>
        <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo.</a></span>
      </p>
    </div>
  </div>
</footer>

    </div>
  </div>
  <script src="/js/jquery-3.4.1.min.js"></script>
<script src="/js/search.json.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>


<script src="/js/script.js"></script>





  <script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



  
    <script src="/localshare/js/social-share.js"></script>
    <script src="/localshare/js/qrcode.js"></script>
  
  



  

  

  

  

  

  

  

  
  





</body>
</html>